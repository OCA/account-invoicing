<?xml version="1.0" encoding="utf-8" ?>
<!-- Copyright 2004-2011 Pexego Sistemas InformÃ¡ticos. (http://pexego.es)
     Copyright 2014 Pedro M. Baeza <pedro.baeza@serviciosbaeza.com>
     Copyright 2016 Antonio Espinosa <antonio.espinosa@tecnativa.com>
     License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl). -->
<odoo>
    <record
        id="view_customer_account_invoice_add_refunds_details_form"
        model="ir.ui.view"
    >
        <field name="name">Account invoice for customer budget (form)</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form" />
        <field name="arch" type="xml">
            <xpath
                expr="//group[@id='header_right_group']/field[@name='currency_id']"
                position="before"
            >
                <field name="is_budget" />
            </xpath>
            <notebook position="inside">
                <page
                    name="budget_consumption"
                    string="Budget consumption"
                    attrs="{'invisible':[('is_budget', '=', False)]}"
                >
                    <field name="budget_consumption_line_ids" nolabel="1">
                        <tree
                            decoration-muted="parent_state == 'cancel'"
                            decoration-danger="parent_state=='draft'"
                            decoration-info="parent_state=='posted'"
                        >
                              <field
                                name="product_id"
                                optional="show"
                                domain="
                                                    context.get('default_move_type') in ('out_invoice', 'out_refund', 'out_receipt')
                                                    and [('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]
                                                    or [('purchase_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]
                                               "
                            />

                            <field
                                name="name"
                                widget="section_and_note_text"
                                optional="show"
                            />
                            <field name="partner_id" />
                            <field name="move_id" />
                            <field
                                name="account_id"
                                context="{'partner_id': partner_id, 'move_type': parent.move_type}"
                                groups="account.group_account_readonly"
                                options="{'no_create': True}"
                                domain="[('deprecated', '=', False), ('account_type', 'not in', ('asset_receivable', 'liability_payable')), ('company_id', '=', parent.company_id), ('is_off_balance', '=', False)]"
                                attrs="{'required': [('display_type', 'not in', ('line_note', 'line_section'))]}"
                            />
                            <field
                                name="analytic_distribution"
                                widget="analytic_distribution"
                                groups="analytic.group_analytic_accounting"
                                optional="show"
                                options="{'product_field': 'product_id', 'account_field': 'account_id'}"
                                business_domain_compute="parent.move_type in ['out_invoice', 'out_refund', 'out_receipt'] and 'invoice' or parent.move_type in ['in_invoice', 'in_refund', 'in_receipt'] and 'bill' or 'general'"
                            />
                            <field name="quantity" optional="show" />
                            <field name="product_uom_category_id" invisible="1" />
                            <field
                                name="product_uom_id"
                                string="UoM"
                                groups="uom.group_uom"
                                optional="show"
                            />
                            <field name="price_unit" string="Price" />
                            <field name="discount" string="Disc.%" optional="hide" />
                            <field
                                name="tax_ids"
                                widget="many2many_tags"
                                domain="[('type_tax_use', '=?', parent.invoice_filter_type_domain), ('company_id', '=', parent.company_id), ('country_id', '=', parent.tax_country_id)]"
                                context="{'append_type_to_tax_name': not parent.invoice_filter_type_domain}"
                                options="{'no_create': True}"
                                optional="show"
                            />
                            <field name="price_subtotal" string="Subtotal" />
                            <field name="price_total" string="Total" />
                            <field name="parent_state" />
                            <!-- Others fields -->
                            <field name="currency_id" invisible="1" />
                            <field name="company_id" invisible="1" />
                            <field name="company_currency_id" invisible="1" />
                            <field name="display_type" force_save="1" invisible="1" />
                        </tree>
                        <form>
                            <sheet>
                                <field name="display_type" invisible="1" />
                                <field name="company_id" invisible="1" />
                                <field name="partner_id" invisible="1" />
                                <group>
                                    <field
                                        name="product_id"
                                        widget="many2one_barcode"
                                    />
                                    <field name="quantity" />
                                    <field
                                        name="product_uom_category_id"
                                        invisible="1"
                                    />
                                    <field
                                        name="product_uom_id"
                                        groups="uom.group_uom"
                                    />
                                    <field name="price_unit" />
                                    <field name="discount" string="Disc.%" />
                                </group>
                                <group>
                                    <field
                                        name="account_id"
                                        options="{'no_create': True}"
                                        domain="[('company_id', '=', company_id)]"
                                        context="{'partner_id': partner_id, 'move_type': parent.move_type}"
                                    />
                                    <field name="tax_ids" widget="many2many_tags" />
                                    <field
                                        name="analytic_distribution"
                                        widget="analytic_distribution"
                                        groups="analytic.group_analytic_accounting"
                                    />
                                </group>
                                <label
                                    for="name"
                                    string="Description"
                                    attrs="{'invisible': [('display_type', 'in', ('line_note', 'line_section'))]}"
                                />
                                <label
                                    for="name"
                                    string="Section"
                                    attrs="{'invisible': [('display_type', '!=', 'line_section')]}"
                                />
                                <label
                                    for="name"
                                    string="Note"
                                    attrs="{'invisible': [('display_type', '!=', 'line_note')]}"
                                />
                                <field name="name" widget="text" />
                                <group>
                                    <field
                                        name="price_subtotal"
                                        string="Subtotal"
                                        groups="account.group_show_line_subtotals_tax_excluded"
                                    />
                                    <field
                                        name="price_total"
                                        string="Total"
                                        groups="account.group_show_line_subtotals_tax_included"
                                    />
                                </group>
                            </sheet>
                        </form>
                    </field>
                </page>
            </notebook>
            <!-- Add link to budget_invoice_id to account.move.line -->
            <xpath
                expr="//field[@name='invoice_line_ids']/tree/field[@name='company_id']"
                position="after"
            >
                <field
                    name="budget_invoice_id"
                    invisible="0"
                    attrs="{'column_invisible': [('parent.move_type', '!=', 'out_invoice'), ('parent.is_budget', '=', True)]}"
                    optional="hide"
                />
            </xpath>
            <xpath
                expr="//field[@name='line_ids']/tree/field[@name='analytic_distribution']"
                position="after"
            >
                <field
                    name="budget_invoice_id"
                    attrs="{'column_invisible': [('parent.move_type', '!=', 'out_invoice'), ('parent.is_budget', '=', True)]}"
                />
            </xpath>
            <xpath expr="//field[@name='tax_totals']/.." position="after">

                <group
                    class="oe_subtotal_footer oe_right"
                    attrs="{'invisible':[('is_budget', '=', False)]}"
                >

                    <field
                        name="budget_total_consumption"
                        class="oe_subtotal_footer_separator"
                        attrs="{'invisible': [('state', '=', 'draft')]}"
                    />

                    <field
                        name="budget_residual"
                        class="oe_subtotal_footer_separator"
                        attrs="{'invisible': [('state', '=', 'draft')]}"
                    />
                </group>
            </xpath>

        </field>
    </record>

        <record id="account.action_move_out_invoice_type" model="ir.actions.act_window">
            <field
            name="domain"
        >[('move_type', '=', 'out_invoice'), ('is_budget', '!=', True)]</field>
            <field name="context">{'default_move_type': 'out_invoice'}</field>
        </record>

    <record id="view_budget_invoice_tree" model="ir.ui.view">
        <field name="name">account.budget.invoice.tree</field>
        <field name="model">account.move</field>
        <field name="arch" type="xml">
            <tree
                string="Budgets"
                js_class="account_tree"
                decoration-info="state == 'draft'"
                decoration-muted="state == 'cancel'"
                expand="context.get('expand', False)"
                sample="1"
            >
                <header>
                    <button
                        name="action_register_payment"
                        type="object"
                        string="Register Payment"
                        groups="account.group_account_user"
                        invisible="context.get('default_move_type') not in ('out_invoice', 'out_refund', 'out_receipt', 'in_invoice', 'in_refund','in_receipt')"
                    />
                </header>
                <field name="made_sequence_hole" invisible="1" />
                <field
                    name="name"
                    decoration-bf="1"
                    decoration-danger="made_sequence_hole"
                />
                <field
                    name="invoice_partner_display_name"
                    invisible="context.get('default_move_type') not in ('in_invoice', 'in_refund','in_receipt')"
                    groups="base.group_user"
                    string="Vendor"
                />
                <field
                    name="invoice_partner_display_name"
                    invisible="context.get('default_move_type') not in ('out_invoice', 'out_refund','out_receipt')"
                    groups="base.group_user"
                    string="Customer"
                />
                <field
                    name="invoice_date"
                    optional="show"
                    invisible="context.get('default_move_type') not in ('in_invoice', 'in_refund','in_receipt')"
                    string="Bill Date"
                />
                <field
                    name="invoice_date"
                    optional="show"
                    invisible="context.get('default_move_type') not in ('out_invoice', 'out_refund','out_receipt')"
                    string="Invoice Date"
                />
                <field name="date" optional="hide" string="Accounting Date" />
                <field
                    name="invoice_date_due"
                    widget="remaining_days"
                    optional="show"
                    attrs="{'invisible': [['payment_state', 'in', ('paid', 'in_payment', 'reversed')]]}"
                />
                <field name="invoice_origin" optional="hide" string="Source Document" />
                <field
                    name="payment_reference"
                    optional="hide"
                    invisible="context.get('default_move_type') in ('out_invoice', 'out_refund','out_receipt')"
                />
                <field name="ref" optional="hide" />
                <field
                    name="invoice_user_id"
                    optional="hide"
                    invisible="context.get('default_move_type') not in ('out_invoice', 'out_refund','out_receipt')"
                    string="Salesperson"
                    widget="many2one_avatar_user"
                />
                <field name="activity_ids" widget="list_activity" optional="show" />
                <field
                    name="company_id"
                    groups="base.group_multi_company"
                    options="{'no_create': True}"
                    optional="hide"
                />
                <field
                    name="amount_untaxed_signed"
                    string="Tax Excluded"
                    sum="Total"
                    optional="show"
                />
                <field
                    name="amount_tax_signed"
                    string="Tax"
                    sum="Total"
                    optional="hide"
                />
                <field
                    name="amount_total_signed"
                    string="Total"
                    sum="Total"
                    decoration-bf="1"
                    optional="show"
                />
                <field
                    name="amount_total_in_currency_signed"
                    string="Total in Currency"
                    groups="base.group_multi_currency"
                    optional="show"
                />
                <field
                    name="amount_residual_signed"
                    string="Amount Due"
                    sum="Amount Due"
                    optional="hide"
                />
                <field name="is_budget" invisible="1" />
                <field
                    name="budget_total_consumption"
                    sum="Total Consumption Budget"
                    optional="show"
                />
                <field
                    name="budget_residual"
                    sum="Total Residual Budget"
                    optional="show"
                />
                <field
                    name="currency_id"
                    groups="base.group_multi_currency"
                    optional="hide"
                />
                <field name="company_currency_id" invisible="1" />
                <field name="to_check" optional="hide" widget="boolean_toggle" />
                <field
                    name="payment_state"
                    widget="badge"
                    decoration-danger="payment_state == 'not_paid'"
                    decoration-warning="payment_state in ('partial', 'in_payment')"
                    decoration-success="payment_state in ('paid', 'reversed')"
                    attrs="{'invisible': [('payment_state', 'in', ('invoicing_legacy'))]}"
                    optional="show"
                />
                <field
                    name="state"
                    widget="badge"
                    decoration-success="state == 'posted'"
                    decoration-info="state == 'draft'"
                    optional="show"
                />
                <field
                    name="move_type"
                    invisible="context.get('default_move_type', True)"
                />
              </tree>
        </field>
    </record>

    <record id="action_move_out_invoice_budget_type" model="ir.actions.act_window">
            <field name="name">Budgets</field>
            <field name="res_model">account.move</field>
            <field name="view_mode">tree,kanban,form</field>
            <field name="view_id" ref="view_budget_invoice_tree" />
            <field name="search_view_id" ref="account.view_account_invoice_filter" />
            <field
            name="domain"
        >[('move_type', '=', 'out_invoice'), ('is_budget', '=', True)]</field>
            <field name="context">{'default_move_type': 'out_invoice'}</field>
            <field name="help" type="html">
              <p class="o_view_nocontent_smiling_face">
                Create a customer Budget
              </p><p>
                Create Budget, register payments and keep track of the discussions with your customers.
              </p>
            </field>
    </record>
    <menuitem
        id="menu_action_move_out_refund_type"
        action="action_move_out_invoice_budget_type"
        parent="account.menu_finance_receivables"
        sequence="4"
    />
</odoo>
